name: The main GitHub Actions for testing pr

on:
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - &checkout
        name: Копирование кода в раннер
        uses: actions/checkout@v4
      - name: Подготовка среды
        uses: .github/actions/setup
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.1

  try-build:
    needs:
      - golangci
    name: Сборка приложения
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      - *checkout
      - name: Подготовка среды
        uses: .github/actions/setup
      - name: Попытка собрать приложение
        run: go build -v ./... -o /dev/null

  unit-tests:
    needs:
    - try-build
    name: Запуск unit-тестов
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
      - *checkout
      - name: Подготовка среды
        uses: .github/actions/setup
      - name: Запуск Unit-тестов
        run: go test ./...
      - name: Проверка на состояние гонки
        run: go test --race ./...